<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FOY International College ‚Äî School Management</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --sidebar-width: 260px;
      --accent: #0d6efd;
      --muted: #6c757d;
    }

    html,body{height:100%;}
    body{
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#f8fafc,#f3f6fb 60%);
      color:#222;
    }

    .app {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      gap: 1.5rem;
      min-height: 100vh;
    }
    .sidebar {
      background: #fff;
      border-right: 1px solid rgba(15,23,42,0.05);
      padding: 1.25rem;
      position: sticky;
      top: 0;
      height: 100vh;
    }
    .main { padding: 1.5rem; }

    .brand { font-weight:700; color:var(--accent); font-size:1.05rem; }
    .nav-link { color: #374151; }
    .nav-link.active { background: rgba(13,110,253,0.08); color:var(--accent); border-radius:8px; }

    .card { border-radius:12px; box-shadow:0 6px 18px rgba(15,23,42,0.04); border:none; }

    .btn-whatsapp{ background:#25D366; color:#fff; border: none; }
    .btn-email{ background:var(--accent); color:#fff; border: none; }

    .table thead th { position: sticky; top: 0; z-index: 1; background: #fff; }
    .table-responsive-xl { overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:10px; }
    .small-muted { font-size:0.85rem; color:var(--muted); }

    @media (max-width: 992px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; border-right:none; border-bottom:1px solid rgba(15,23,42,0.03); }
    }

    .badge-status { min-width:72px; display:inline-block; }
    .action-row .btn { margin-right:6px; margin-bottom:6px; }
    .search-input { max-width:420px; }
  </style>
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="d-flex align-items-center mb-4">
      <div class="me-2">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none"><path d="M12 2L2 7v7c0 5 4 9 10 9s10-4 10-9V7l-10-5z" fill="#0d6efd" opacity=".12"/><path d="M12 2l10 5v7c0 5-4 9-10 9S2 19 2 14V7l10-5z" fill="#0d6efd"/></svg>
      </div>
      <div>
        <div class="brand">FOY INTERNATIONAL COLLEGE</div>
        <div class="small-muted">School Management Dashboard</div>
      </div>
    </div>

    <nav class="nav flex-column mb-3">
      <a class="nav-link active" data-tab="teachers" href="#" onclick="showTab('teachers')">üë©‚Äçüè´ Teachers</a>
      <a class="nav-link" data-tab="students" href="#" onclick="showTab('students')">üë®‚Äçüéì Students</a>
      <a class="nav-link" data-tab="parents" href="#" onclick="showTab('parents')">üë™ Parents</a>
      <a class="nav-link" data-tab="reports" href="#" onclick="showTab('reports')">üìä Reports</a>
    </nav>

    <hr>

    <div class="mb-3">
      <div class="small-muted mb-1">Quick Actions</div>
      <div class="d-grid gap-2">
        <button class="btn btn-outline-primary" onclick="exportJSON()">Export JSON</button>
        <button class="btn btn-outline-secondary" onclick="refreshNow()">Refresh</button>
      </div>
    </div>

    <div class="mt-auto small-muted">
      <div>¬© <strong>FOY INTERNATIONAL COLLEGE</strong></div>
      <div>Admin Management System</div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0">FOY INTERNATIONAL COLLEGE ‚Äî Admin</h3>
        <div class="small-muted">Manage teachers, students, parents, attendance & payments</div>
      </div>

      <div class="d-flex align-items-center">
        <input id="globalSearch" class="form-control form-control-sm me-2 search-input" placeholder="Search by name / class / email" />
        <button class="btn btn-outline-secondary btn-sm me-2" onclick="renderAll()">Search</button>
        <button class="btn btn-primary btn-sm" onclick="showTab('students')">+ Add Student</button>
      </div>
    </div>

    <section id="tab-content">

      <!-- TEACHERS TAB -->
      <div id="teachers" class="tab-panel">
        <div class="row g-3">
          <div class="col-12 col-xl-4">
            <div class="card p-3">
              <h5 class="mb-2">Add Teacher</h5>
              <form id="teacherForm">
                <div class="row g-2">
                  <div class="col-12"><input id="tName" class="form-control" placeholder="Full name" required></div>
                  <div class="col-6"><input id="tAge" type="number" min="18" class="form-control" placeholder="Age"></div>
                  <div class="col-6"><input id="tPhone" class="form-control" placeholder="Phone (include country code e.g. 234801...)" required></div>
                  <div class="col-6"><input id="tEmail" class="form-control" placeholder="Email" required></div>
                  <div class="col-6"><input id="tSubject" class="form-control" placeholder="Subject / Department"></div>
                  <div class="col-12 text-end">
                    <button class="btn btn-primary mt-2" type="submit">Add Teacher</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="col-12 col-xl-8">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Teachers</h5>
                <div class="small-muted">Total: <span id="countTeachers">0</span></div>
              </div>

              <div class="table-responsive-xl">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Name</th><th>Phone</th><th>Email</th><th>Subject</th><th>Age</th>
                      <th class="text-center">Attendance</th><th class="text-center">Payment</th><th class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="teacherTable"></tbody>
                </table>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- STUDENTS TAB -->
      <div id="students" class="tab-panel" style="display:none;">
        <div class="row g-3">
          <div class="col-12 col-xl-5">
            <div class="card p-3">
              <h5 class="mb-2">Add Student</h5>
              <form id="studentForm">
                <div class="row g-2">
                  <div class="col-12"><input id="sName" class="form-control" placeholder="Student full name" required></div>
                  <div class="col-6"><select id="sGender" class="form-select" required><option value="">Gender</option><option>Male</option><option>Female</option></select></div>
                  <div class="col-6"><input id="sClass" class="form-control" placeholder="Class (e.g. JS1)" required></div>
                  <div class="col-6"><input id="sAge" type="number" min="3" class="form-control" placeholder="Age"></div>
                  <div class="col-6"><select id="sTerm" class="form-select" required><option value="">Term</option><option>First Term</option><option>Second Term</option><option>Third Term</option></select></div>
                  <div class="col-6"><select id="sTeacher" class="form-select"><option value="">Assign Teacher</option></select></div>
                  <div class="col-6"><input id="sParentName" class="form-control" placeholder="Parent name (or parent id)"></div>
                  <div class="col-12"><textarea id="sAgenda" class="form-control" rows="2" placeholder="Agenda / notes (optional)"></textarea></div>
                  <div class="col-12 text-end"><button class="btn btn-success mt-2" type="submit">Add Student</button></div>
                </div>
              </form>
            </div>
          </div>

          <div class="col-12 col-xl-7">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Students</h5>
                <div class="small-muted">Total: <span id="countStudents">0</span></div>
              </div>

              <div class="table-responsive-xl">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Name</th><th>Gender</th><th>Class</th><th>Term</th><th>Age</th>
                      <th>Teacher</th><th>Parent</th><th class="text-center">Attendance</th><th class="text-center">Payment</th><th class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="studentTable"></tbody>
                </table>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- PARENTS TAB -->
      <div id="parents" class="tab-panel" style="display:none;">
        <div class="row g-3">
          <div class="col-12 col-xl-4">
            <div class="card p-3">
              <h5 class="mb-2">Add Parent</h5>
              <form id="parentForm">
                <div class="row g-2">
                  <div class="col-12"><input id="pName" class="form-control" placeholder="Parent full name" required></div>
                  <div class="col-6"><input id="pPhone" class="form-control" placeholder="Phone (include country code)" required></div>
                  <div class="col-6"><input id="pEmail" class="form-control" placeholder="Email"></div>
                  <div class="col-6"><input id="pAge" class="form-control" type="number" min="18" placeholder="Age"></div>
                  <div class="col-6"><input id="pStudentName" class="form-control" placeholder="Linked Student name or id"></div>
                  <div class="col-12 text-end"><button class="btn btn-info mt-2" type="submit">Add Parent</button></div>
                </div>
              </form>
            </div>
          </div>

          <div class="col-12 col-xl-8">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Parents</h5>
                <div class="small-muted">Total: <span id="countParents">0</span></div>
              </div>

              <div class="table-responsive-xl">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr><th>Name</th><th>Phone</th><th>Email</th><th>Age</th><th>Student</th><th class="text-center">Actions</th></tr>
                  </thead>
                  <tbody id="parentTable"></tbody>
                </table>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- REPORTS (basic) -->
      <div id="reports" class="tab-panel" style="display:none;">
        <div class="card p-3">
          <h5>Quick Reports</h5>
          <div class="row g-3 mt-2">
            <div class="col-12 col-md-4"><div class="card p-3"><div class="small-muted">Teachers Present</div><div class="h4" id="reportTeachersPresent">0</div></div></div>
            <div class="col-12 col-md-4"><div class="card p-3"><div class="small-muted">Students Present</div><div class="h4" id="reportStudentsPresent">0</div></div></div>
            <div class="col-12 col-md-4"><div class="card p-3"><div class="small-muted">Unpaid (Teachers + Students)</div><div class="h4" id="reportUnpaidCount">0</div></div></div>
          </div>
        </div>
      </div>

    </section>
  </main>
</div>

<!-- Supabase & Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- App Script -->
<script>
/* -------------------------
  Supabase config (from you)
------------------------- */
const SUPABASE_URL = "https://pjedtymwfyjmzluejygs.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqZWR0eW13ZnlqbXpsdWVqeWdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjE4OTYsImV4cCI6MjA3NjAzNzg5Nn0.g7p_nlemO1ZvpGMPwutsnr2SmlE4jVZw-VCGsbQK530";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------------------------
  Local cached data
------------------------- */
let schoolData = { teachers: [], students: [], parents: [] };

/* -------------------------
  Helpers
------------------------- */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str).replace(/[&<>'"]/g, tag => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
  }[tag]));
}

function numericPhone(str) {
  if (!str) return '';
  return String(str).replace(/[^0-9]/g,'');
}

/* -------------------------
  Fetch all data from Supabase
------------------------- */
async function fetchAllData() {
  try {
    const [tRes, sRes, pRes] = await Promise.all([
      supabase.from('teachers').select('*').order('id', { ascending: false }),
      supabase.from('students').select('*').order('id', { ascending: false }),
      supabase.from('parents').select('*').order('id', { ascending: false })
    ]);
    schoolData.teachers = tRes.error ? [] : (tRes.data || []);
    schoolData.students = sRes.error ? [] : (sRes.data || []);
    schoolData.parents = pRes.error ? [] : (pRes.data || []);
  } catch (err) {
    console.error('fetchAllData error', err);
  }
}

/* -------------------------
  Render / UI helpers
------------------------- */
function updateDropdowns() {
  const sTeacherEl = document.getElementById('sTeacher');
  if (sTeacherEl) {
    sTeacherEl.innerHTML = '<option value="">Assign Teacher</option>' +
      schoolData.teachers.map(t => `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`).join('');
  }
}

/* --- Render teachers --- */
function renderTeachers() {
  const teacherTable = document.getElementById('teacherTable');
  if (!teacherTable) return;
  const q = (document.getElementById('globalSearch')?.value || '').toLowerCase().trim();
  const list = schoolData.teachers.filter(t => !q || Object.values(t).join(' ').toLowerCase().includes(q));
  document.getElementById('countTeachers').innerText = list.length;

  teacherTable.innerHTML = list.map(t => `
    <tr>
      <td>${escapeHtml(t.name)}</td>
      <td>${escapeHtml(t.phone || '')}</td>
      <td>${escapeHtml(t.email || '')}</td>
      <td>${escapeHtml(t.subject || '')}</td>
      <td>${escapeHtml(t.age || '')}</td>
      <td class="text-center">
        <span class="badge ${t.attendance === 'Present' ? 'bg-success' : 'bg-secondary'}">${escapeHtml(t.attendance || 'Absent')}</span><br>
        <button class="btn btn-sm btn-outline-success mt-1" onclick="toggleAttendance('teacher', ${t.id})">Toggle</button>
      </td>
      <td class="text-center">
        <span class="badge ${((t.payment||'').toString().toLowerCase() === 'paid') ? 'bg-primary' : 'bg-danger'}">${escapeHtml(t.payment || 'Unpaid')}</span><br>
        <button class="btn btn-sm btn-outline-primary mt-1" onclick="togglePayment('teacher', ${t.id})">Toggle</button>
      </td>
      <td class="text-center action-row">
        <button class="btn btn-sm btn-outline-success" onclick="adminCall('${escapeHtml(numericPhone(t.phone))}')">üìû</button>
        <button class="btn btn-sm btn-outline-info" onclick="adminEmail('${escapeHtml(t.email)}')">‚úâÔ∏è</button>
        <button class="btn btn-sm btn-whatsapp" onclick="adminWhatsApp('${escapeHtml(numericPhone(t.phone))}', '${escapeHtml(t.name)}')">üí¨</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('teacher', ${t.id})">üóëÔ∏è</button>
      </td>
    </tr>
  `).join('');
}

/* --- Render students --- */
function renderStudents() {
  const studentTable = document.getElementById('studentTable');
  if (!studentTable) return;
  const q = (document.getElementById('globalSearch')?.value || '').toLowerCase().trim();
  const list = schoolData.students.filter(s => !q || Object.values(s).join(' ').toLowerCase().includes(q));
  document.getElementById('countStudents').innerText = list.length;

  studentTable.innerHTML = list.map(s => {
    const teacherObj = schoolData.teachers.find(t => String(t.id) === String(s.teacherId));
    const teacherName = teacherObj ? teacherObj.name : '‚Äî';
    return `<tr>
      <td>${escapeHtml(s.name)}</td>
      <td>${escapeHtml(s.gender || '')}</td>
      <td>${escapeHtml(s.className || s.class || '')}</td>
      <td>${escapeHtml(s.term || '')}</td>
      <td>${escapeHtml(s.age || '')}</td>
      <td>${escapeHtml(teacherName)}</td>
      <td>${escapeHtml(s.parent_name || s.parent || '‚Äî')}</td>
      <td class="text-center">
        <span class="badge ${s.attendance === 'Present' ? 'bg-success' : 'bg-secondary'}">${escapeHtml(s.attendance || 'Absent')}</span><br>
        <button class="btn btn-sm btn-outline-success mt-1" onclick="toggleAttendance('student', ${s.id})">Toggle</button>
      </td>
      <td class="text-center">
        <span class="badge ${((s.payment||'').toString().toLowerCase() === 'paid') ? 'bg-primary' : 'bg-danger'}">${escapeHtml(s.payment || 'Unpaid')}</span><br>
        <button class="btn btn-sm btn-outline-primary mt-1" onclick="togglePayment('student', ${s.id})">Toggle</button>
      </td>
      <td class="text-center action-row">
        <button class="btn btn-sm btn-outline-success" onclick="adminCall('${escapeHtml(numericPhone(s.phone))}')">üìû</button>
        <button class="btn btn-sm btn-outline-info" onclick="adminEmail('${escapeHtml(s.email)}')">‚úâÔ∏è</button>
        <button class="btn btn-sm btn-whatsapp" onclick="adminWhatsApp('${escapeHtml(numericPhone(s.phone))}', '${escapeHtml(s.name)}')">üí¨</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('student', ${s.id})">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

/* --- Render parents --- */
function renderParents() {
  const parentTable = document.getElementById('parentTable');
  if (!parentTable) return;
  const q = (document.getElementById('globalSearch')?.value || '').toLowerCase().trim();
  const list = schoolData.parents.filter(p => !q || Object.values(p).join(' ').toLowerCase().includes(q));
  document.getElementById('countParents').innerText = list.length;

  parentTable.innerHTML = list.map(p => `
    <tr>
      <td>${escapeHtml(p.name)}</td>
      <td>${escapeHtml(p.phone || '')}</td>
      <td>${escapeHtml(p.email || '')}</td>
      <td>${escapeHtml(p.age || '')}</td>
      <td>${escapeHtml(p.student_name || p.student || '‚Äî')}</td>
      <td class="text-center action-row">
        <button class="btn btn-sm btn-outline-success" onclick="adminCall('${escapeHtml(numericPhone(p.phone))}')">üìû</button>
        <button class="btn btn-sm btn-outline-info" onclick="adminEmail('${escapeHtml(p.email)}')">‚úâÔ∏è</button>
        <button class="btn btn-sm btn-whatsapp" onclick="adminWhatsApp('${escapeHtml(numericPhone(p.phone))}', '${escapeHtml(p.name)}')">üí¨</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('parent', ${p.id})">üóëÔ∏è</button>
      </td>
    </tr>
  `).join('');
}

/* --- Reports --- */
function renderReports() {
  const teachersPresent = schoolData.teachers.filter(t => t.attendance === 'Present').length;
  const studentsPresent = schoolData.students.filter(s => s.attendance === 'Present').length;
  const unpaidCount =
    schoolData.teachers.filter(t => !t.payment || (t.payment||'').toString().toLowerCase() !== 'paid').length +
    schoolData.students.filter(s => !s.payment || (s.payment||'').toString().toLowerCase() !== 'paid').length;

  document.getElementById('reportTeachersPresent').innerText = teachersPresent;
  document.getElementById('reportStudentsPresent').innerText = studentsPresent;
  document.getElementById('reportUnpaidCount').innerText = unpaidCount;
}

/* --- Full render --- */
async function renderAll() {
  await fetchAllData();
  updateDropdowns();
  renderTeachers();
  renderStudents();
  renderParents();
  renderReports();
}

/* -------------------------
  CRUD: Add / Delete
------------------------- */
async function addTeacher(e) {
  if (e && e.preventDefault) e.preventDefault();
  const t = {
    name: (document.getElementById('tName')?.value || '').trim(),
    phone: (document.getElementById('tPhone')?.value || '').trim(),
    email: (document.getElementById('tEmail')?.value || '').trim(),
    subject: (document.getElementById('tSubject')?.value || '').trim(),
    age: parseInt(document.getElementById('tAge')?.value) || null,
    attendance: 'Absent',
    payment: 'Unpaid'
  };
  const { error } = await supabase.from('teachers').insert(t);
  if (error) return alert('Error adding teacher: ' + error.message);
  document.getElementById('teacherForm')?.reset();
  await renderAll();
}

async function addStudent(e) {
  if (e && e.preventDefault) e.preventDefault();
  const s = {
    name: (document.getElementById('sName')?.value || '').trim(),
    gender: (document.getElementById('sGender')?.value || '').trim(),
    className: (document.getElementById('sClass')?.value || '').trim(),
    term: (document.getElementById('sTerm')?.value || '').trim(),
    agenda: (document.getElementById('sAgenda')?.value || '').trim(),
    teacherId: document.getElementById('sTeacher')?.value || null,
    parent_name: (document.getElementById('sParentName')?.value || '').trim(),
    age: parseInt(document.getElementById('sAge')?.value) || null,
    attendance: 'Absent',
    payment: 'Unpaid'
  };
  const { error } = await supabase.from('students').insert(s);
  if (error) return alert('Error adding student: ' + error.message);
  document.getElementById('studentForm')?.reset();
  await renderAll();
}

async function addParent(e) {
  if (e && e.preventDefault) e.preventDefault();
  const p = {
    name: (document.getElementById('pName')?.value || '').trim(),
    phone: (document.getElementById('pPhone')?.value || '').trim(),
    email: (document.getElementById('pEmail')?.value || '').trim(),
    student_name: (document.getElementById('pStudentName')?.value || '').trim(),
    age: parseInt(document.getElementById('pAge')?.value) || null
  };
  const { error } = await supabase.from('parents').insert(p);
  if (error) return alert('Error adding parent: ' + error.message);
  document.getElementById('parentForm')?.reset();
  await renderAll();
}

async function deleteRecord(type, id) {
  if (!confirm('Delete this record?')) return;
  const table = type + 's';
  const { error } = await supabase.from(table).delete().eq('id', id);
  if (error) console.error('delete error', error);
  await renderAll();
}

/* -------------------------
  Toggle attendance / payment
------------------------- */
async function toggleAttendance(type, id) {
  const table = type === 'teacher' ? 'teachers' : 'students';
  try {
    const { data, error } = await supabase.from(table).select('attendance').eq('id', id).single();
    if (error) { console.error(error); return; }
    const current = data?.attendance || 'Absent';
    const newVal = current === 'Present' ? 'Absent' : 'Present';
    await supabase.from(table).update({ attendance: newVal }).eq('id', id);
    await renderAll();
  } catch (err) { console.error('toggleAttendance error', err); }
}

async function togglePayment(type, id) {
  const table = type === 'teacher' ? 'teachers' : 'students';
  try {
    const { data, error } = await supabase.from(table).select('payment').eq('id', id).single();
    if (error) { console.error(error); return; }
    const current = (data?.payment || 'Unpaid').toString();
    const newVal = current.toLowerCase() === 'paid' ? 'Unpaid' : 'Paid';
    await supabase.from(table).update({ payment: newVal }).eq('id', id);
    await renderAll();
  } catch (err) { console.error('togglePayment error', err); }
}

/* -------------------------
  Admin contact actions
  (admin can call, email, WhatsApp)
------------------------- */
function adminCall(phone) {
  if (!phone) return alert('No phone number available');
  window.open('tel:' + phone);
}

function adminEmail(email) {
  if (!email) return alert('No email available');
  window.open('mailto:' + email);
}

function adminWhatsApp(phone, name) {
  if (!phone) return alert('No WhatsApp number available');
  const msg = `Hello ${name || ''}, this is FOY International College.`;
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
}

/* -------------------------
  Utilities
------------------------- */
function exportJSON() {
  const full = JSON.stringify(schoolData, null, 2);
  const blob = new Blob([full], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'foy-school-data.json'; a.click();
  URL.revokeObjectURL(url);
}

function refreshNow() { renderAll(); }

function showTab(name) {
  document.querySelectorAll('.nav-link').forEach(n => n.classList.toggle('active', n.dataset.tab === name));
  document.querySelectorAll('.tab-panel').forEach(panel => panel.style.display = (panel.id === name ? '' : 'none'));
  window.scrollTo({ top: 0, behavior: 'smooth' });
  renderAll();
}

/* -------------------------
  Wiring + initial render
------------------------- */
document.addEventListener('DOMContentLoaded', async () => {
  // attach handlers
  document.getElementById('teacherForm')?.addEventListener('submit', addTeacher);
  document.getElementById('studentForm')?.addEventListener('submit', addStudent);
  document.getElementById('parentForm')?.addEventListener('submit', addParent);

  const gs = document.getElementById('globalSearch');
  if (gs) {
    gs.addEventListener('keydown', (e) => { if (e.key === 'Enter') renderAll(); });
    gs.addEventListener('input', () => renderAll());
  }

  // expose some functions globally for inline onClick usage
  window.toggleAttendance = toggleAttendance;
  window.togglePayment = togglePayment;
  window.deleteRecord = deleteRecord;
  window.adminCall = adminCall;
  window.adminEmail = adminEmail;
  window.adminWhatsApp = adminWhatsApp;
  window.showTab = showTab;
  window.renderAll = renderAll;

  // initial render
  await renderAll();
});
</script>
<script>
  if (localStorage.getItem('foyAdminLoggedIn') !== 'true') {
    window.location.href = 'index.html';
  }
</script>

</body>
</html>